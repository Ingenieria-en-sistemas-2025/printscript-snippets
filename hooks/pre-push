#!/usr/bin/env sh
# pre-push: formatter + linter + tests + auto-repush
set -euo pipefail

# Evitar loop cuando reintentamos el push desde el propio hook
if [ "${GIT_HOOK_REPUSH:-}" = "1" ]; then
  exit 0
fi

if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "Hay cambios sin commitear (working tree o index sucio). Hac√© commit antes de pushear."
  exit 1
fi

./gradlew --no-daemon --quiet spotlessApply

SPOTLESS_CHANGED=0
if ! git diff --quiet; then
  SPOTLESS_CHANGED=1
  git add -u
fi

./gradlew --no-daemon --quiet detekt

./gradlew --no-daemon --quiet spotlessCheck

./gradlew --no-daemon --quiet clean check

if [ "$SPOTLESS_CHANGED" -eq 1 ]; then
  git commit -m "style: apply Spotless"
  GIT_HOOK_REPUSH=1 exec git push --no-verify "$@"
fi

echo "pre-push OK"