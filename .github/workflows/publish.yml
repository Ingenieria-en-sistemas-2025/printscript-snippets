name:  CI + Publish Docker image

on:
  push:
    branches: [ "dev", "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
#    baja el codigo del repo a la vm de GitHub
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      #corre build completo
      - name: Build (tests, detekt, spotless, etc.)
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew --no-daemon clean build

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            **/build/reports/tests/test
            **/build/reports/jacoco/test/html
            **/build/reports/detekt
            **/build/reports/spotless

  publish:
    name: Build & Push Docker image
    #solo se ejecuta si ci termina en ok
    needs: ci
    # corre para push a dev o main
    if: github.event_name == 'push' && (github.ref_name == 'dev' || github.ref_name == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      #convierte el sha largo del commit en corto
      - name: Create short SHA
        id: short-sha
        uses: benjlevesque/short-sha@v1.2
        with:
          length: 8

      #prepara el entorno para el paso de build
      # es el build moderno de docker p/construir imgs
      - name: Docker Buildx
        uses: docker/setup-buildx-action@v3

      #loguea al GHCR usando el token del repo
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}


        #Calcular el nombre de la imagen y los tags
      - name: Compute images and tags
        id: meta
        run: |
          IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}"
        #guarda image como output del step
          echo "image=$IMAGE" >> $GITHUB_OUTPUT  
          
          {
            echo "tags<<EOF"
            echo "$IMAGE:${{ steps.short-sha.outputs.sha }}"
            if [ "${{ github.ref_name }}" = "main" ]; then
              echo "$IMAGE:latest"
            fi
            if [ "${{ github.ref_name }}" = "dev" ]; then
              echo "$IMAGE:dev-latest"
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          #le dice que suba la img al registry desp de construirla
          push: true
          build-args: |
            GITHUB_ACTOR=${{ github.actor }}
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          tags: ${{ steps.meta.outputs.tags }}
          provenance: false


  deploy:
    needs: publish
    if: github.event_name == 'push' && (github.ref_name == 'dev' || github.ref_name == 'main')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Start DEV VM
        if: github.ref_name == 'dev'
        run: |
          az vm start -g "${{ secrets.AZ_RG_DEV }}" -n "${{ secrets.AZ_VM_DEV_NAME }}"
          # Esperar a que el SSH responda (máx ~2 min)
          for i in {1..24}; do
            nc -z ${{ secrets.VM_DEV_HOST }} 22 && echo "SSH listo" && exit 0
            echo "Esperando SSH..." && sleep 5
          done
          echo "Timeout esperando SSH" && exit 1
      - name: Start PROD VM
        if: github.ref_name == 'main'
        run: |
          az vm start -g "${{ secrets.AZ_RG_PROD }}" -n "${{ secrets.AZ_VM_PROD_NAME }}"
          # Esperar a que el SSH responda (máx ~2 min)
          for i in {1..24}; do
            nc -z ${{ secrets.VM_PROD_HOST }} 22 && echo "SSH listo" && exit 0
            echo "Esperando SSH..." && sleep 5
          done
          echo "Timeout esperando SSH" && exit 1

      - name: Deploy to DEV over SSH
        if: github.ref_name == 'dev'
        #para conectarse por SSH a una VM y ejecutar comandos.
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        with:
          host: ${{ secrets.VM_DEV_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_DEV_SSH_KEY }}
          script: |
            set -e
            cd ~/infrastructure
            git fetch --all
            git checkout dev || true
            git pull || true
            if [ -n "${GHCR_USER}" ] && [ -n "${GHCR_PAT}" ]; then
              echo "$GHCR_PAT" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
            fi
            
            SVC_NAME="snippets"
            docker compose pull "$SVC_NAME"
            docker compose up -d --no-deps "$SVC_NAME"
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Ports}}"


      - name: Deploy to PROD over SSH #separadas
        if: github.ref_name == 'main'
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        with:
          host: ${{ secrets.VM_PROD_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_PROD_SSH_KEY }}
          script: |
            set -e
            cd ~/infrastructure
            git fetch --all
            git checkout main || true
            git pull || true
            if [ -n "${GHCR_USER}" ] && [ -n "${GHCR_PAT}" ]; then
              echo "$GHCR_PAT" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
            fi
            
            SVC_NAME="snippets"
            docker compose pull "$SVC_NAME"
            docker compose up -d --no-deps "$SVC_NAME"
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Ports}}"